<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>초간단 웹 투표</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        /* Custom styles for modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
        }
        .modal-content {
            background-color: white;
            padding: 1.5rem;
            border-radius: 0.5rem;
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.1);
            max-width: 24rem;
            width: 100%;
            text-align: center;
        }
        .modal-error-border {
            border-top: 4px solid #ef4444; /* red-500 */
        }
        .modal-info-border {
            border-top: 4px solid #6366f1; /* indigo-500 */
        }
    </style>
</head>
<body class="font-inter antialiased bg-gray-50 text-gray-900 min-h-screen">
    <div id="app" class="min-h-screen"></div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, onSnapshot, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase configuration and app ID are provided by the Canvas environment
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Initialize Firebase
        let app;
        let db;
        let auth;
        let unsubscribePollSnapshot = null; // To store the unsubscribe function for multi-device poll

        try {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
        } catch (error) {
            console.error("Firebase initialization failed:", error);
            showCustomModal("Firebase 초기화에 실패했습니다.", "error");
        }

        // Global state for the application
        const appState = {
            currentView: 'home', // 'home', 'singleDeviceCreate', 'singleDeviceVote', 'singleDeviceResults', 'multiDeviceCreate', 'multiDeviceShare', 'multiDeviceVote', 'multiDeviceResults'
            pollTitle: '',
            pollOptions: ['', ''],
            isMultiSelect: false,
            voterCount: 1,
            currentVoterIndex: 0,
            singleDeviceVotes: [], // For single device, store votes as array of arrays
            singleDevicePollResults: {}, // For single device, calculated results
            activePollId: null, // For multi-device polls
            multiDevicePollData: null, // Data for the active multi-device poll
            multiDevicePollResults: {}, // Results for multi-device poll
            isAuthReady: false,
            userId: null,
            showResultsAfterClose: false,
            pollClosed: false,
            qrCodeUrl: null,
            modal: {
                show: false,
                message: '',
                type: 'info' // 'info', 'error'
            }
        };

        // --- Utility Functions ---
        function showCustomModal(message, type = 'info') {
            appState.modal.message = message;
            appState.modal.type = type;
            appState.modal.show = true;
            renderModal();
        }

        function closeModal() {
            appState.modal.show = false;
            appState.modal.message = '';
            appState.modal.type = 'info';
            renderModal();
        }

        function renderModal() {
            const modalOverlay = document.getElementById('modal-overlay');
            if (appState.modal.show) {
                if (!modalOverlay) {
                    const overlay = document.createElement('div');
                    overlay.id = 'modal-overlay';
                    overlay.className = 'modal-overlay';
                    document.body.appendChild(overlay);
                }
                const currentOverlay = document.getElementById('modal-overlay');
                currentOverlay.innerHTML = `
                    <div class="modal-content ${appState.modal.type === 'error' ? 'modal-error-border' : 'modal-info-border'}">
                        <h3 class="text-xl font-bold mb-4">
                            ${appState.modal.type === 'error' ? '오류 발생' : '알림'}
                        </h3>
                        <p class="text-gray-700 mb-6">${appState.modal.message}</p>
                        <button id="modal-close-button" class="w-full py-2 px-4 rounded-lg font-semibold transition-colors duration-200 ${appState.modal.type === 'error' ? 'bg-red-500 hover:bg-red-600 text-white' : 'bg-indigo-500 hover:bg-indigo-600 text-white'}">
                            확인
                        </button>
                    </div>
                `;
                document.getElementById('modal-close-button').onclick = closeModal;
            } else {
                if (modalOverlay) {
                    modalOverlay.remove();
                }
            }
        }

        function handleAddOption() {
            appState.pollOptions.push('');
            renderPollCreationForm(appState.currentView === 'singleDeviceCreate' ? 'single' : 'multi');
        }

        function handleOptionChange(index, value) {
            appState.pollOptions[index] = value;
        }

        function handleRemoveOption(index) {
            appState.pollOptions.splice(index, 1);
            renderPollCreationForm(appState.currentView === 'singleDeviceCreate' ? 'single' : 'multi');
        }

        // --- Single-Device Poll Logic ---
        function startSingleDevicePoll() {
            if (!appState.pollTitle.trim() || appState.pollOptions.some(opt => !opt.trim())) {
                showCustomModal("투표 제목과 모든 항목을 입력해주세요.");
                return;
            }
            appState.singleDeviceVotes = Array(appState.voterCount).fill([]);
            appState.currentVoterIndex = 0;
            navigateTo('singleDeviceVote');
        }

        function handleSingleDeviceVote(optionIndex) {
            const newVotes = [...appState.singleDeviceVotes];
            if (appState.isMultiSelect) {
                if (newVotes[appState.currentVoterIndex].includes(optionIndex)) {
                    newVotes[appState.currentVoterIndex] = newVotes[appState.currentVoterIndex].filter(item => item !== optionIndex);
                } else {
                    newVotes[appState.currentVoterIndex] = [...newVotes[appState.currentVoterIndex], optionIndex];
                }
            } else {
                newVotes[appState.currentVoterIndex] = [optionIndex];
            }
            appState.singleDeviceVotes = newVotes;
            renderSingleDeviceVoteView(); // Re-render to show selection
        }

        function submitSingleDeviceVoteAndNext() {
            if (appState.currentVoterIndex < appState.voterCount - 1) {
                appState.currentVoterIndex++;
                showCustomModal("다음 사람 투표하세요!");
                renderSingleDeviceVoteView();
            } else {
                calculateSingleDeviceResults();
                navigateTo('singleDeviceResults');
            }
        }

        function calculateSingleDeviceResults() {
            const results = {};
            appState.pollOptions.forEach((_, index) => {
                results[index] = 0;
            });

            appState.singleDeviceVotes.forEach(voterSelections => {
                voterSelections.forEach(optionIndex => {
                    results[optionIndex]++;
                });
            });
            appState.singleDevicePollResults = results;
        }

        // --- Multi-Device Poll Logic ---
        function generatePollId() {
            return Math.random().toString(36).substring(2, 8); // Simple 6-character ID
        }

        async function createMultiDevicePoll() {
            if (!appState.pollTitle.trim() || appState.pollOptions.some(opt => !opt.trim())) {
                showCustomModal("투표 제목과 모든 항목을 입력해주세요.");
                return;
            }

            if (!appState.isAuthReady || !appState.userId) {
                showCustomModal("인증 준비 중입니다. 잠시 후 다시 시도해주세요.", "error");
                return;
            }

            const newPollId = generatePollId();
            const pollRef = doc(db, `artifacts/${appId}/public/data/polls`, newPollId);
            const pollData = {
                title: appState.pollTitle,
                options: appState.pollOptions,
                isMultiSelect: appState.isMultiSelect,
                creatorId: appState.userId,
                createdAt: new Date().toISOString(),
                votes: {}, // Stores votes as { userId: [optionIndex, ...], ... }
                closed: false,
                showResultsAfterClose: appState.showResultsAfterClose,
            };

            try {
                await setDoc(pollRef, pollData);
                appState.activePollId = newPollId;
                appState.multiDevicePollData = pollData;
                appState.qrCodeUrl = `https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${encodeURIComponent(window.location.origin + '/share/' + newPollId)}`;
                navigateTo('multiDeviceShare');
            } catch (e) {
                console.error("Error creating multi-device poll:", e);
                showCustomModal("투표 생성에 실패했습니다.", "error");
            }
        }

        async function fetchMultiDevicePoll(pollId) {
            if (!db) return;
            // Unsubscribe from previous listener if exists
            if (unsubscribePollSnapshot) {
                unsubscribePollSnapshot();
            }

            const pollDocRef = doc(db, `artifacts/${appId}/public/data/polls`, pollId);
            unsubscribePollSnapshot = onSnapshot(pollDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    appState.multiDevicePollData = data;
                    appState.pollTitle = data.title;
                    appState.pollOptions = data.options;
                    appState.isMultiSelect = data.isMultiSelect;
                    appState.showResultsAfterClose = data.showResultsAfterClose;
                    appState.pollClosed = data.closed || false;
                    if (data.votes) {
                        calculateMultiDeviceResults(data.votes, data.options);
                    }
                    if (appState.currentView === 'multiDeviceVote') {
                        renderMultiDeviceVoteView();
                    } else if (appState.currentView === 'multiDeviceResults') {
                        renderResultsView(appState.multiDevicePollResults, appState.multiDevicePollData.options, appState.multiDevicePollData.title, 'multi');
                    }
                } else {
                    showCustomModal("투표를 찾을 수 없습니다.", "error");
                    navigateTo('home');
                }
            }, (error) => {
                console.error("Error fetching multi-device poll:", error);
                showCustomModal("투표 데이터를 가져오는 데 실패했습니다.", "error");
                navigateTo('home');
            });
        }

        async function handleMultiDeviceVote(optionIndex) {
            if (!appState.activePollId || !appState.userId || !appState.multiDevicePollData || appState.pollClosed) {
                showCustomModal(appState.pollClosed ? "이 투표는 마감되었습니다." : "투표를 할 수 없습니다.", "error");
                return;
            }

            const pollRef = doc(db, `artifacts/${appId}/public/data/polls`, appState.activePollId);
            let newVotes = { ...appState.multiDevicePollData.votes };
            let userVotes = newVotes[appState.userId] || [];

            if (appState.multiDevicePollData.isMultiSelect) {
                if (userVotes.includes(optionIndex)) {
                    userVotes = userVotes.filter(item => item !== optionIndex);
                } else {
                    userVotes = [...userVotes, optionIndex];
                }
            } else {
                userVotes = [optionIndex]; // For single select, always replace
            }
            newVotes[appState.userId] = userVotes;

            try {
                await updateDoc(pollRef, { votes: newVotes });
                // The onSnapshot listener will update multiDevicePollData and recalculate results
            } catch (e) {
                console.error("Error submitting multi-device vote:", e);
                showCustomModal("투표 제출에 실패했습니다.", "error");
            }
        }

        function calculateMultiDeviceResults(votes, options) {
            const results = {};
            options.forEach((_, index) => {
                results[index] = 0;
            });

            Object.values(votes).forEach(userSelections => {
                userSelections.forEach(optionIndex => {
                    results[optionIndex]++;
                });
            });
            appState.multiDevicePollResults = results;
        }

        async function closeMultiDevicePoll() {
            if (!appState.activePollId || !appState.multiDevicePollData || appState.multiDevicePollData.creatorId !== appState.userId) {
                showCustomModal("투표를 마감할 권한이 없습니다.", "error");
                return;
            }
            const pollRef = doc(db, `artifacts/${appId}/public/data/polls`, appState.activePollId);
            try {
                await updateDoc(pollRef, { closed: true });
                showCustomModal("투표가 마감되었습니다.");
            } catch (e) {
                console.error("Error closing poll:", e);
                showCustomModal("투표 마감에 실패했습니다.", "error");
            }
        }

        function resetPollCreation() {
            appState.pollTitle = '';
            appState.pollOptions = ['', ''];
            appState.isMultiSelect = false;
            appState.voterCount = 1;
            appState.showResultsAfterClose = false;
            appState.activePollId = null;
            appState.multiDevicePollData = null;
            appState.multiDevicePollResults = {};
            appState.currentVoterIndex = 0;
            appState.singleDeviceVotes = [];
            appState.singleDevicePollResults = {};
            appState.pollClosed = false;
            appState.qrCodeUrl = null;
            if (unsubscribePollSnapshot) {
                unsubscribePollSnapshot();
                unsubscribePollSnapshot = null;
            }
        }

        function navigateTo(view) {
            resetPollCreation();
            appState.currentView = view;
            if (view === 'home') {
                window.history.pushState({}, '', '/');
            } else if (view === 'multiDeviceCreate') {
                window.history.pushState({}, '', '/share');
            }
            renderApp();
        }

        // --- Render Functions for different views ---
        function renderHomeView() {
            const appDiv = document.getElementById('app');
            appDiv.innerHTML = `
                <div class="flex flex-col items-center justify-center h-full p-4 min-h-screen">
                    <h1 class="text-4xl font-bold mb-8 text-gray-800">초간단 웹 투표</h1>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8 w-full max-w-4xl">
                        <div class="bg-white p-8 rounded-xl shadow-lg border border-gray-200 hover:shadow-xl transition-shadow duration-300">
                            <h2 class="text-2xl font-semibold mb-4 text-gray-700">한 기기용 (단말기 공유 투표)</h2>
                            <p class="text-gray-600 mb-6">
                                별도 기기 없이 하나의 태블릿, 노트북으로 여러 명이 순서대로 투표할 수 있습니다. 교실, 회의, 소규모 모임에 최적화되어 있습니다.
                            </p>
                            <button id="single-device-create-btn"
                                class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-lg shadow-md transition-colors duration-300 transform hover:scale-105">
                                시작하기
                            </button>
                        </div>
                        <div class="bg-white p-8 rounded-xl shadow-lg border border-gray-200 hover:shadow-xl transition-shadow duration-300">
                            <h2 class="text-2xl font-semibold mb-4 text-gray-700">여러 기기용 (링크 공유 투표)</h2>
                            <p class="text-gray-600 mb-6">
                                QR 코드 또는 링크 공유를 통해 각자 스마트폰으로 간편하게 투표에 참여할 수 있습니다. 실시간 결과 확인도 가능합니다.
                            </p>
                            <button id="multi-device-create-btn"
                                class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg shadow-md transition-colors duration-300 transform hover:scale-105">
                                시작하기
                            </button>
                        </div>
                    </div>
                    ${appState.userId ? `
                    <p class="mt-8 text-sm text-gray-500">
                        현재 사용자 ID: <span class="font-mono bg-gray-100 px-2 py-1 rounded">${appState.userId}</span>
                    </p>
                    ` : ''}
                </div>
            `;
            document.getElementById('single-device-create-btn').onclick = () => navigateTo('singleDeviceCreate');
            document.getElementById('multi-device-create-btn').onclick = () => navigateTo('multiDeviceCreate');
        }

        function renderPollCreationForm(type) {
            const appDiv = document.getElementById('app');
            appDiv.innerHTML = `
                <div class="flex flex-col items-center p-4 bg-gray-50 min-h-screen">
                    <div class="bg-white p-8 rounded-xl shadow-lg w-full max-w-2xl mt-8">
                        <h2 class="text-3xl font-bold mb-6 text-gray-800 text-center">
                            ${type === 'single' ? '한 기기용 투표 생성' : '여러 기기용 투표 생성'}
                        </h2>

                        <div class="mb-6">
                            <label for="poll-title" class="block text-lg font-medium text-gray-700 mb-2">투표 제목</label>
                            <input
                                type="text"
                                id="poll-title"
                                value="${appState.pollTitle}"
                                placeholder="예: 오늘 점심 메뉴는?"
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 text-lg"
                            />
                        </div>

                        <div class="mb-6">
                            <label class="block text-lg font-medium text-gray-700 mb-2">투표 항목</label>
                            <div id="poll-options-container">
                                ${appState.pollOptions.map((option, index) => `
                                <div class="flex items-center mb-3">
                                    <input
                                        type="text"
                                        value="${option}"
                                        data-index="${index}"
                                        placeholder="항목 ${index + 1}"
                                        class="flex-grow px-4 py-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 text-lg mr-2 option-input"
                                    />
                                    ${appState.pollOptions.length > 2 ? `
                                    <button
                                        data-index="${index}"
                                        class="bg-red-500 hover:bg-red-600 text-white p-3 rounded-lg text-xl remove-option-btn"
                                        aria-label="Remove option ${index + 1}"
                                    >
                                        &times;
                                    </button>
                                    ` : ''}
                                </div>
                                `).join('')}
                            </div>
                            <button id="add-option-btn"
                                class="w-full bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-3 rounded-lg transition-colors duration-200">
                                항목 추가
                            </button>
                        </div>

                        <div class="mb-6 flex items-center">
                            <input
                                type="checkbox"
                                id="multi-select"
                                ${appState.isMultiSelect ? 'checked' : ''}
                                class="h-5 w-5 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500"
                            />
                            <label for="multi-select" class="ml-3 text-lg font-medium text-gray-700">복수 선택 허용</label>
                        </div>

                        ${type === 'single' ? `
                        <div class="mb-6">
                            <label for="voter-count" class="block text-lg font-medium text-gray-700 mb-2">투표 인원</label>
                            <input
                                type="number"
                                id="voter-count"
                                value="${appState.voterCount}"
                                min="1"
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 text-lg"
                            />
                        </div>
                        ` : ''}

                        ${type === 'multi' ? `
                        <div class="mb-6 flex items-center">
                            <input
                                type="checkbox"
                                id="show-results-after-close"
                                ${appState.showResultsAfterClose ? 'checked' : ''}
                                class="h-5 w-5 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500"
                            />
                            <label for="show-results-after-close" class="ml-3 text-lg font-medium text-gray-700">
                                투표 마감 후 결과 공개
                            </label>
                        </div>
                        ` : ''}

                        <button id="create-poll-btn"
                            class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-4 px-6 rounded-lg shadow-md transition-colors duration-300 transform hover:scale-105 text-xl">
                            투표 시작
                        </button>
                        <button id="back-to-home-btn"
                            class="w-full mt-4 bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-3 px-6 rounded-lg transition-colors duration-300">
                            홈으로 돌아가기
                        </button>
                    </div>
                </div>
            `;

            // Attach event listeners
            document.getElementById('poll-title').oninput = (e) => appState.pollTitle = e.target.value;
            document.getElementById('add-option-btn').onclick = handleAddOption;
            document.getElementById('multi-select').onchange = (e) => appState.isMultiSelect = e.target.checked;

            document.querySelectorAll('.option-input').forEach(input => {
                input.oninput = (e) => handleOptionChange(parseInt(e.target.dataset.index), e.target.value);
            });
            document.querySelectorAll('.remove-option-btn').forEach(button => {
                button.onclick = (e) => handleRemoveOption(parseInt(e.target.dataset.index));
            });

            if (type === 'single') {
                document.getElementById('voter-count').oninput = (e) => appState.voterCount = Math.max(1, parseInt(e.target.value) || 1);
                document.getElementById('create-poll-btn').onclick = startSingleDevicePoll;
            } else { // multi
                document.getElementById('show-results-after-close').onchange = (e) => appState.showResultsAfterClose = e.target.checked;
                document.getElementById('create-poll-btn').onclick = createMultiDevicePoll;
            }
            document.getElementById('back-to-home-btn').onclick = () => navigateTo('home');
        }

        function renderSingleDeviceVoteView() {
            const appDiv = document.getElementById('app');
            const currentVoterVotes = appState.singleDeviceVotes[appState.currentVoterIndex] || [];
            appDiv.innerHTML = `
                <div class="flex flex-col items-center p-4 bg-gray-50 min-h-screen">
                    <div class="bg-white p-8 rounded-xl shadow-lg w-full max-w-xl mt-8 text-center">
                        <h2 class="text-3xl font-bold mb-4 text-gray-800">${appState.pollTitle}</h2>
                        <p class="text-xl text-gray-600 mb-6">
                            <span class="font-semibold text-indigo-600">${appState.currentVoterIndex + 1}번째</span> 투표자
                        </p>

                        <div class="grid grid-cols-1 gap-4 mb-8">
                            ${appState.pollOptions.map((option, index) => `
                            <button
                                data-index="${index}"
                                class="vote-option-btn p-5 rounded-lg text-xl font-semibold transition-all duration-200
                                ${currentVoterVotes.includes(index)
                                    ? 'bg-indigo-600 text-white shadow-md transform scale-105'
                                    : 'bg-indigo-100 text-indigo-800 hover:bg-indigo-200'
                                }
                            ">
                                ${option}
                            </button>
                            `).join('')}
                        </div>

                        <button id="submit-vote-next-btn"
                            class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-4 px-6 rounded-lg shadow-md transition-colors duration-300 transform hover:scale-105 text-xl">
                            ${appState.currentVoterIndex < appState.voterCount - 1 ? '다음 사람 투표' : '결과 보기'}
                        </button>
                        <button id="back-to-home-btn"
                            class="w-full mt-4 bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-3 px-6 rounded-lg transition-colors duration-300">
                            홈으로 돌아가기
                        </button>
                    </div>
                </div>
            `;
            document.querySelectorAll('.vote-option-btn').forEach(button => {
                button.onclick = (e) => handleSingleDeviceVote(parseInt(e.target.dataset.index));
            });
            document.getElementById('submit-vote-next-btn').onclick = submitSingleDeviceVoteAndNext;
            document.getElementById('back-to-home-btn').onclick = () => navigateTo('home');
        }

        function renderResultsView(results, options, title, type, showBackToHome = true) {
            const appDiv = document.getElementById('app');
            const totalVotes = Object.values(results).reduce((sum, count) => sum + count, 0);

            const sortedResults = Object.entries(results)
                .map(([index, count]) => ({
                    option: options[parseInt(index)],
                    count: count,
                    percentage: totalVotes > 0 ? (count / totalVotes) * 100 : 0
                }))
                .sort((a, b) => b.count - a.count);

            appDiv.innerHTML = `
                <div class="flex flex-col items-center p-4 bg-gray-50 min-h-screen">
                    <div class="bg-white p-8 rounded-xl shadow-lg w-full max-w-2xl mt-8">
                        <h2 class="text-3xl font-bold mb-6 text-gray-800 text-center">
                            "${title}" 투표 결과
                        </h2>

                        <div class="space-y-4 mb-8">
                            ${sortedResults.map((item, index) => `
                            <div class="flex items-center">
                                <span class="text-lg font-medium text-gray-700 w-1/3">${item.option}</span>
                                <div class="flex-grow bg-gray-200 rounded-full h-8 relative overflow-hidden">
                                    <div
                                        class="bg-indigo-500 h-full rounded-full flex items-center justify-end pr-2 text-white font-bold"
                                        style="width: ${item.percentage}%"
                                    >
                                        ${item.count > 0 ? `${Math.round(item.percentage)}%` : ''}
                                    </div>
                                </div>
                                <span class="ml-4 text-lg font-semibold text-gray-800 w-16 text-right">${item.count}표</span>
                            </div>
                            `).join('')}
                        </div>

                        ${type === 'multi' && appState.multiDevicePollData && appState.multiDevicePollData.creatorId === appState.userId && !appState.pollClosed ? `
                        <button id="close-poll-btn"
                            class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-6 rounded-lg shadow-md transition-colors duration-300 transform hover:scale-105 text-lg mb-4">
                            투표 마감하기
                        </button>
                        ` : ''}

                        ${showBackToHome ? `
                        <button id="back-to-home-btn"
                            class="w-full bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-3 px-6 rounded-lg transition-colors duration-300">
                            홈으로 돌아가기
                        </button>
                        ` : ''}
                    </div>
                </div>
            `;
            if (type === 'multi' && appState.multiDevicePollData && appState.multiDevicePollData.creatorId === appState.userId && !appState.pollClosed) {
                document.getElementById('close-poll-btn').onclick = closeMultiDevicePoll;
            }
            if (showBackToHome) {
                document.getElementById('back-to-home-btn').onclick = () => navigateTo('home');
            }
        }

        function renderMultiDeviceShareView() {
            const appDiv = document.getElementById('app');
            appDiv.innerHTML = `
                <div class="flex flex-col items-center p-4 bg-gray-50 min-h-screen">
                    <div class="bg-white p-8 rounded-xl shadow-lg w-full max-w-xl mt-8 text-center">
                        <h2 class="text-3xl font-bold mb-6 text-gray-800">투표가 생성되었습니다!</h2>
                        <p class="text-xl text-gray-600 mb-4">
                            아래 링크 또는 QR 코드를 공유하여 투표에 참여하세요.
                        </p>

                        <div class="mb-6 bg-gray-100 p-4 rounded-lg break-words">
                            <p class="text-lg font-mono text-gray-800">
                                <a href="${window.location.origin}/share/${appState.activePollId}" target="_blank" rel="noopener noreferrer" class="text-indigo-600 hover:underline">
                                    ${window.location.origin}/share/${appState.activePollId}
                                </a>
                            </p>
                        </div>

                        ${appState.qrCodeUrl ? `
                        <div class="mb-8 p-4 border border-gray-200 rounded-lg inline-block">
                            <img src="${appState.qrCodeUrl}" alt="QR Code" class="w-48 h-48 mx-auto" />
                            <p class="text-sm text-gray-500 mt-2">QR 코드를 스캔하여 참여</p>
                        </div>
                        ` : ''}

                        <button id="view-results-btn"
                            class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-4 px-6 rounded-lg shadow-md transition-colors duration-300 transform hover:scale-105 text-xl mb-4">
                            실시간 결과 보기
                        </button>
                        <button id="back-to-home-btn"
                            class="w-full bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-3 px-6 rounded-lg transition-colors duration-300">
                            홈으로 돌아가기
                        </button>
                    </div>
                </div>
            `;
            document.getElementById('view-results-btn').onclick = () => {
                appState.currentView = 'multiDeviceResults';
                renderApp();
            };
            document.getElementById('back-to-home-btn').onclick = () => navigateTo('home');
        }

        function renderMultiDeviceVoteView() {
            const appDiv = document.getElementById('app');
            if (!appState.multiDevicePollData) {
                appDiv.innerHTML = `
                    <div class="flex items-center justify-center min-h-screen bg-gray-50">
                        <p class="text-xl text-gray-700">투표 정보를 불러오는 중입니다...</p>
                    </div>
                `;
                return;
            }

            const hasVoted = appState.multiDevicePollData.votes && appState.multiDevicePollData.votes[appState.userId];
            const userCurrentVotes = hasVoted ? appState.multiDevicePollData.votes[appState.userId] : [];

            appDiv.innerHTML = `
                <div class="flex flex-col items-center p-4 bg-gray-50 min-h-screen">
                    <div class="bg-white p-8 rounded-xl shadow-lg w-full max-w-xl mt-8 text-center">
                        <h2 class="text-3xl font-bold mb-4 text-gray-800">${appState.multiDevicePollData.title}</h2>
                        ${appState.pollClosed ? `
                            <p class="text-red-500 text-2xl font-bold mb-6">이 투표는 마감되었습니다.</p>
                        ` : `
                            <p class="text-xl text-gray-600 mb-6">
                                ${appState.multiDevicePollData.isMultiSelect ? '복수 선택 가능' : '하나만 선택 가능'}
                            </p>
                        `}

                        <div class="grid grid-cols-1 gap-4 mb-8">
                            ${appState.multiDevicePollData.options.map((option, index) => `
                            <button
                                data-index="${index}"
                                ${appState.pollClosed ? 'disabled' : ''}
                                class="vote-option-btn p-5 rounded-lg text-xl font-semibold transition-all duration-200
                                ${userCurrentVotes.includes(index)
                                    ? 'bg-indigo-600 text-white shadow-md transform scale-105'
                                    : 'bg-indigo-100 text-indigo-800 hover:bg-indigo-200'
                                }
                                ${appState.pollClosed ? 'opacity-60 cursor-not-allowed' : ''}
                            ">
                                ${option}
                            </button>
                            `).join('')}
                        </div>

                        ${appState.multiDevicePollData.showResultsAfterClose && !appState.pollClosed ? `
                            <p class="text-gray-500 text-lg mb-4">
                                결과는 투표 마감 후 공개됩니다.
                            </p>
                        ` : ''}

                        ${!appState.multiDevicePollData.showResultsAfterClose ? `
                            <button id="view-results-btn"
                                class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-4 px-6 rounded-lg shadow-md transition-colors duration-300 transform hover:scale-105 text-xl mb-4">
                                실시간 결과 보기
                            </button>
                        ` : ''}
                        <button id="back-to-home-btn"
                            class="w-full bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-3 px-6 rounded-lg transition-colors duration-300">
                            홈으로 돌아가기
                        </button>
                    </div>
                </div>
            `;
            document.querySelectorAll('.vote-option-btn').forEach(button => {
                button.onclick = (e) => handleMultiDeviceVote(parseInt(e.target.dataset.index));
            });
            if (!appState.multiDevicePollData.showResultsAfterClose) {
                document.getElementById('view-results-btn').onclick = () => {
                    appState.currentView = 'multiDeviceResults';
                    renderApp();
                };
            }
            document.getElementById('back-to-home-btn').onclick = () => navigateTo('home');
        }

        // Main render function to switch views
        function renderApp() {
            switch (appState.currentView) {
                case 'home':
                    renderHomeView();
                    break;
                case 'singleDeviceCreate':
                    renderPollCreationForm('single');
                    break;
                case 'singleDeviceVote':
                    renderSingleDeviceVoteView();
                    break;
                case 'singleDeviceResults':
                    renderResultsView(appState.singleDevicePollResults, appState.pollOptions, appState.pollTitle, 'single');
                    break;
                case 'multiDeviceCreate':
                    renderPollCreationForm('multi');
                    break;
                case 'multiDeviceShare':
                    renderMultiDeviceShareView();
                    break;
                case 'multiDeviceVote':
                    renderMultiDeviceVoteView();
                    break;
                case 'multiDeviceResults':
                    renderResultsView(appState.multiDevicePollResults, appState.multiDevicePollData.options, appState.multiDevicePollData.title, 'multi');
                    break;
                default:
                    renderHomeView();
            }
            renderModal(); // Ensure modal is rendered on top if active
        }

        // Initial Firebase Auth and Firestore Initialization
        async function initializeFirebaseAndAuth() {
            try {
                if (!auth.currentUser) {
                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                    } else {
                        await signInAnonymously(auth);
                    }
                }
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        appState.userId = user.uid;
                    } else {
                        appState.userId = crypto.randomUUID(); // Fallback for unauthenticated users
                    }
                    appState.isAuthReady = true;
                    // Handle URL-based poll access after auth is ready
                    const path = window.location.pathname;
                    const pollIdFromUrl = path.split('/share/')[1];
                    if (pollIdFromUrl) {
                        appState.activePollId = pollIdFromUrl;
                        appState.currentView = 'multiDeviceVote';
                        fetchMultiDevicePoll(pollIdFromUrl);
                    } else if (path === '/share') {
                        appState.currentView = 'multiDeviceCreate';
                    } else {
                        appState.currentView = 'home';
                    }
                    renderApp(); // Initial render after auth is ready and view is set
                });
            } catch (error) {
                console.error("Firebase authentication failed:", error);
                showCustomModal("Firebase 인증에 실패했습니다.", "error");
                appState.userId = crypto.randomUUID(); // Still set a random ID to proceed
                appState.isAuthReady = true;
                renderApp(); // Render even if auth fails
            }
        }

        // Start the application when the DOM is fully loaded
        window.onload = function() {
            if (app && db && auth) {
                initializeFirebaseAndAuth();
            } else {
                showCustomModal("Firebase가 올바르게 초기화되지 않았습니다. 콘솔 오류를 확인하십시오.", "error");
                // Fallback to home view if Firebase init fails
                appState.currentView = 'home';
                renderApp();
            }
        };
    </script>
</body>
</html>
